@using Relaks.Models.Store
@using Relaks.Database.Repositories

@* <Dump Data="@Store.Req"/> *@

<div class="list-group list-group-flush">
    @foreach (var item in Store.Categories.ToTreeSelect())
    {
        <p>@item.Title</p>
    }
</div>

<div class="mb-3">
    <div class="input-group">
        <input type="text" class="form-control" @bind="@Store.Req.Search" @oninput="@OnInputSearch" placeholder="Поиск...">
        <button class="btn btn-outline-secondary" type="button" @onclick="@OnCleanSearch">
            <i class="las la-times la-lg"></i>
        </button>
    </div>
</div>

<div class="mb-3">
    <div class="form-check form-switch">
        <InputCheckbox class="form-check-input" type="checkbox" @bind-Value="@Store.Req.IsDeleted" @oninput="@OnChangeIsDeleted" id="@Ids["IsDeleted"]"/>
        <label class="form-check-label" for="@Ids["IsDeleted"]">Архивные файлы</label>
    </div>
</div>

<AppFileSidebarHeader Title="Категории"
                      WithAdd="@Store.WithEdit"
                      WithEdit="@Store.WithEdit"
                      OnAdd="@(() => { Store.State = AppFileListStore.StateEnum.AddCategory; OnStateHasChanged.InvokeAsync();})"/>

<div class="list-group list-group-flush">
    @foreach (var category in Store.Categories)
    {
        <AppFileCategoryItem Category="@category"/>
    }
</div>

<AppFileSidebarHeader Title="Метки"
                      WithAdd="@Store.WithEdit"
                      WithEdit="@Store.WithEdit"
                      OnEdit="@SwitchEditTags"
                      OnAdd="@(() => { Store.State = AppFileListStore.StateEnum.AddTag; OnStateHasChanged.InvokeAsync();})"/>

@if (Store.State.Equals(AppFileListStore.StateEnum.EditTags))
{
    <p class="text-center text-muted small"><i class="fa-solid fa-edit fa-beat me-1"></i> Нажмите на метку для изменения</p>
}
<div class="d-flex flex-wrap gap-2">
    @foreach (var tag in Store.Tags)
    {
        <AppFileTagItem Tag="@tag" OnStateChanged="@(() => OnStateHasChanged.InvokeAsync())"/>
    }
</div>

@code {

    private Dictionary<string, Guid> Ids { get; set; } = new()
    {
        {"IsDeleted", Guid.NewGuid()}
    };

    [Parameter]
    public EventCallback OnStateHasChanged { get; set; }

    [CascadingParameter]
    [Parameter]
    public AppFileListStore Store { get; set; } = null!;

    private async Task OnInputSearch(ChangeEventArgs e)
    {
        Store.Req.Search = e.Value?.ToString();
        Store.FindFiles();
        await OnStateHasChanged.InvokeAsync();
    }

    private async Task OnChangeIsDeleted(ChangeEventArgs e)
    {
        Store.Req.IsDeleted = (bool) (e.Value ?? false);
        Store.FindFiles();
        await OnStateHasChanged.InvokeAsync();
    }

    private async Task OnCleanSearch()
    {
        Store.Req.Search = null;
        Store.FindFiles();
        await OnStateHasChanged.InvokeAsync();
    }

    private Task SwitchEditTags()
    {
        Store.State = Store.State.Equals(AppFileListStore.StateEnum.EditTags)
            ? AppFileListStore.StateEnum.Default
            : AppFileListStore.StateEnum.EditTags
            ;
        
        StateHasChanged();
        OnStateHasChanged.InvokeAsync();
        return Task.CompletedTask;
    }

    protected override void OnParametersSet()
    {
    }

}