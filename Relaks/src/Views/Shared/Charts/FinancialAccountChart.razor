@using Relaks.Views.Shared.Charts.ViewModels
@using Relaks.Database
@using System.Text.Json
@using System.Dynamic

@inject IJSRuntime Js;
@inject AppDbContext Db;

@* <Dump Data="@Store.Req"/> *@
@* <Dump Data="@Store.Calculate().Accounts.First()"/> *@
<CascadingValue Value="@Store">
    @if (AccountIds.Any())
    {
        <_Filter OnStateHasChanged="@OnFilterChange"/>
        <_Summary/>
    }
    else
    {
        <p>Выберите один или несколько счетов для отображения статистики</p>
    }
    <div id="@(_id + 1)"></div>
    <div id="@(_id + 2)"></div>
</CascadingValue>

@code {
    [Parameter]
    public List<Guid> AccountIds { get; set; } = new();

    private FinancialAccountStatisticsStore Store { get; set; } = null!;

    private string _id = Guid.NewGuid().ToString(); 

    protected override void OnInitialized()
    {
        Store = new(Db, AccountIds);
        Store.Initialize();
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        return !firstRender ? Task.CompletedTask : InitializeChart();
    }

    private Task OnFilterChange()
    {
        // StateHasChanged();
        return InitializeChart();
    }

    private Task InitializeChart()
    {
        Store.Calculate();
        StateHasChanged();
        
        var firstDict = new Dictionary<string, List<decimal>>();
        var secondDict = new Dictionary<string, List<decimal>>();
        var secondBarGroups = new List<List<string>>();
        foreach (var account in Store.Calculated.Accounts)
        {
            var averageBalanceTitle = "Средний баланс";
            var totalOutlayTitle = "Списания";
            var totalIncomeTitle = "Пополнения";
            var totalTitle = "Сумма";
            
            if (Store.Calculated.Accounts.Count > 1)
            {
                averageBalanceTitle += $" ({account.Title})";
                totalOutlayTitle += $" ({account.Title})";
                totalIncomeTitle += $" ({account.Title})";
                totalTitle += $" ({account.Title})";
            }

            firstDict[averageBalanceTitle] = new List<decimal>();
            secondDict[totalTitle] = new List<decimal>();
            secondDict[totalOutlayTitle] = new List<decimal>();
            secondDict[totalIncomeTitle] = new List<decimal>();
            
            secondBarGroups.Add([totalOutlayTitle, totalIncomeTitle]);

            foreach (var item in account.Items)
            {
                firstDict[averageBalanceTitle].Add(item.AverageBalance);
                secondDict[totalTitle].Add(item.Total);
                secondDict[totalOutlayTitle].Add(-item.TotalOutlay);
                secondDict[totalIncomeTitle].Add(item.TotalIncome);
            }
        }

        var datesFormat = "%d.%m.%Y";
        if (new[]
            {
                FinancialAccountStatisticsRequest.TypeEnum.CustomByMonths,
                FinancialAccountStatisticsRequest.TypeEnum.YearByMonths,
            }.Contains(Store.Req.Type))
        {
            datesFormat = "%m.%Y";
        }
        
        var result = new
        {
            HtmlElementIds = new []{_id + 1, _id + 2},
            Currency = Store.Calculated.CurrencyId,
            Store.Calculated.Dates,
            DatesFormat = datesFormat,
            Data = new
            {
                First = firstDict,
                Second = secondDict,
                SecondBarGroups = secondBarGroups,
            }
        };
        
        return Task.FromResult(Js.InvokeVoidAsync("InitializeFinancialChart", JsonSerializer.Serialize(result)));
    }
}