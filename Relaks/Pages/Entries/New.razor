@page "/entries/new"

@using Relaks.Models.Requests.EntryRequests
@using Relaks.Database
@using Relaks.Mappers
@using Relaks.Models

<PageTemplate>
    <HalfPage IsCentered="@true">
        <MyTitle>
            <BeforeTitle>
                <a href="/entries" class="btn btn-outline-secondary">
                    <i class="las la-arrow-left la-lg me-1"></i> @Resources.Action.Return
                </a>
            </BeforeTitle>
            <ChildContent>@Resources.Action.Add @Resources.Entity.BaseEntry</ChildContent>
        </MyTitle>

        <EditForm Model="@Req" OnSubmit="@OnSubmit">
            <FluentValidationValidator @ref="Validator" DisableAssemblyScanning="@true"/>
            <ValidationSummary/>
            <FormFields Req="@Req"/>
            <div class="mb-3">
                <button type="submit" class="btn btn-primary">
                    <i class="las la-plus-circle la-lg me-1"></i>
                    @Resources.Action.Add
                </button>
            </div>
        </EditForm>
    </HalfPage>
</PageTemplate>

@code {

    [Inject]
    public AppDbContext Db { get; set; } = null!;

    [Inject]
    public NavigationManager NavigationManager { get; set; } = null!;

    private EntryFormRequest Req { get; set; } = null!;
    private FluentValidationValidator Validator { get; set; } = null!;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        Req = new()
        {
            Discriminator = nameof(EPerson),
        };
    }

    private void OnSubmit()
    {
        if (!Validator.Validate()) return;

        BaseEntry entry = Req.Discriminator switch
        {
            nameof(EPerson) => new EPerson(),
            nameof(ECompany) => new ECompany(),
            nameof(EMeet) => new EMeet(),
            _ => throw new ArgumentException($"Error: discriminator {Req.Discriminator} is not supported")
            };
        
        Req.MapTo(entry);
        Db.BaseEntries.Add(entry);
        Db.SaveChanges();
        NavigationManager.NavigateTo($"/entries/{entry.Id}/info");
    }

}